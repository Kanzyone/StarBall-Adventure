<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Ball Adventure: Consumable Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #000; }
        
        /* UI ElemanlarÄ± */
        #game-ui {
            position: absolute; top: 20px; left: 20px; color: gold;
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            pointer-events: none; z-index: 10; display: none;
        }
        #top-right-ui {
            position: absolute; top: 20px; right: 20px; color: #00ffcc;
            font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px #000;
            z-index: 110;
        }

        /* Yetenek HUD */
        #ability-hud {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 120; pointer-events: none;
        }
        .ability-box {
            width: 65px; height: 65px; background: rgba(0,0,0,0.7);
            border: 2px solid #444; border-radius: 10px; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            color: white; font-size: 10px; position: relative; overflow: hidden;
            opacity: 0.3; transition: all 0.3s;
        }
        .ability-box.available { opacity: 1; border-color: #888; }
        .ability-box.active { border-color: #00ffcc; box-shadow: 0 0 15px #00ffcc; transform: scale(1.1); }
        .ability-key { position: absolute; top: 2px; left: 4px; font-weight: bold; color: gold; }
        .ability-count { position: absolute; bottom: 2px; right: 4px; font-weight: bold; color: #00ffcc; font-size: 12px; }
        .cooldown-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(255, 0, 0, 0.4); transition: height 0.1s linear;
        }

        /* Butonlar ve Overlay */
        .back-btn {
            position: absolute; top: 20px; left: 20px;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            color: white; border: 2px solid white;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 150; font-size: 24px;
            transition: all 0.2s;
        }
        .back-btn:hover { background: white; color: black; transform: scale(1.1); }
        
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.95); z-index: 100; color: white;
        }

        #shop-screen {
            background: radial-gradient(circle at center, #1a0033 0%, #050005 100%);
            overflow: hidden; justify-content: flex-start; padding-top: 60px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #ffcc00, #ff9900);
            border: none; padding: 15px 40px; margin: 10px; font-size: 24px;
            font-weight: bold; color: #000; border-radius: 50px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s; min-width: 220px;
            text-transform: uppercase;
        }
        .menu-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px gold; }
        .menu-btn.secondary { background: linear-gradient(135deg, #00ccff, #0066ff); color: white; }

        .shop-tabs { display: flex; gap: 20px; margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 30px; background: rgba(255,255,255,0.1); border: 2px solid transparent;
            color: white; border-radius: 10px; cursor: pointer; font-weight: bold;
        }
        .tab-btn.active { border-color: gold; background: rgba(255,215,0,0.2); }

        #shop-grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); 
            gap: 25px; max-height: 60vh; overflow-y: auto; padding: 20px;
        }
        .shop-item {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 20px;
            text-align: center; border: 2px solid rgba(255,255,255,0.1); width: 160px;
            backdrop-filter: blur(10px); transition: all 0.3s ease; position: relative;
        }
        .shop-item:hover { transform: translateY(-5px); border-color: rgba(255,255,255,0.3); }

        .ball-preview, .ability-icon {
            width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center; font-size: 30px;
        }
        .ball-preview {
            box-shadow: inset -10px -10px 25px rgba(0,0,0,0.6), 0 10px 20px rgba(0,0,0,0.4);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .ability-icon { background: rgba(0,255,204,0.1); border: 2px dashed #00ffcc; color: #00ffcc; }

        #message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #fff; font-size: 32px; text-align: center; display: none;
            background: rgba(0,0,0,0.95); padding: 50px; border-radius: 20px; border: 4px solid gold; z-index: 200;
        }
        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 40px; height: 40px;
            border: 2px solid rgba(0,255,255,0.7); border-radius: 50%; transform: translate(-50%, -50%);
            display: none; pointer-events: none; z-index: 15;
        }
    </style>
</head>
<body>
    <div id="main-menu" class="overlay-screen">
        <h1 style="font-size: 50px; color: gold; margin-bottom: 30px; text-shadow: 0 0 20px orange;">STAR BALL ADVENTURE</h1>
        <button class="menu-btn" onclick="showLevelSelect()">OYNA</button>
        <button class="menu-btn secondary" onclick="openShop()">MAÄžAZA</button>
    </div>

    <div id="level-select" class="overlay-screen" style="display:none;">
        <div class="back-btn" onclick="backToMenu()">&#8592;</div>
        <h2 style="color:gold; font-size: 36px; margin-bottom: 30px;">SEVÄ°YE SEÃ‡</h2>
        <div id="level-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;"></div>
    </div>

    <div id="shop-screen" class="overlay-screen" style="display:none;">
        <div class="back-btn" onclick="backToMenu()">&#8592;</div>
        <h2 style="color:gold; font-size: 36px; margin-bottom: 10px;">MAÄžAZA</h2>
        <p style="color: #00ffcc; font-weight: bold; margin-bottom: 20px;">BAKÄ°YE: <span id="shop-coins-display">0</span> ALTIN</p>
        <div class="shop-tabs">
            <button id="tab-balls" class="tab-btn active" onclick="switchShopTab('balls')">TOPLAR</button>
            <button id="tab-abilities" class="tab-btn" onclick="switchShopTab('abilities')">YETENEKLER (SARF)</button>
        </div>
        <div id="shop-grid"></div>
    </div>

    <div id="top-right-ui">ALTIN: <span id="global-coins">0</span></div>
    <div id="game-ui">
        SEVÄ°YE: <span id="current-level-display">1</span> | 
        YILDIZLAR: <span id="score">0</span> / <span id="target-score">10</span>
    </div>

    <div id="ability-hud" style="display: none;">
        <div class="ability-box" id="abi-dash"><span class="ability-key">1</span><span>DASH</span><span class="ability-count" id="count-dash">0</span><div class="cooldown-overlay" id="cd-dash"></div></div>
        <div class="ability-box" id="abi-shield"><span class="ability-key">2</span><span>SHIELD</span><span class="ability-count" id="count-shield">0</span><div class="cooldown-overlay" id="cd-shield"></div></div>
        <div class="ability-box" id="abi-magnet"><span class="ability-key">3</span><span>MAGNET</span><span class="ability-count" id="count-magnet">0</span><div class="cooldown-overlay" id="cd-magnet"></div></div>
        <div class="ability-box" id="abi-slow"><span class="ability-key">4</span><span>SLOW</span><span class="ability-count" id="count-slow">0</span><div class="cooldown-overlay" id="cd-slow"></div></div>
    </div>

    <div id="message">
        <div id="msg-content"></div>
        <div style="margin-top:30px; display:flex; gap:10px; justify-content:center;">
            <button id="next-lvl-btn" class="menu-btn" style="padding:10px 20px; font-size:18px;">SONRAKÄ°</button>
            <button class="menu-btn secondary" style="padding:10px 20px; font-size:18px;" onclick="backToMenu()">LOBÄ°</button>
        </div>
    </div>

    <div id="crosshair"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, playerBall, clock;
        let score = 0;
        let globalCoins = parseInt(localStorage.getItem('starball_coins')) || 0;
        let currentLevel = 1;
        let completedLevels = JSON.parse(localStorage.getItem('starball_completed')) || [];
        let stars = [], enemies = [], mazeWalls = [], iceProjectiles = [];
        let isFPS = false, isGameOver = false, isPaused = true;
        let activeShopTab = 'balls';

        // PahalÄ±lÄ±k SÄ±ralamasÄ± (Ters): Magnet en ucuz, Dash en pahalÄ±
        const abilities = {
            magnet: { cd: 8, duration: 4, timer: 0, active: 0, lastUsed: 0, range: 15, price: 150, icon: 'ðŸ§²' },
            slow: { cd: 12, duration: 3, timer: 0, active: 0, lastUsed: 0, price: 350, icon: 'â³' },
            shield: { cd: 10, duration: 5, timer: 0, active: 0, lastUsed: 0, mesh: null, price: 600, icon: 'ðŸ›¡ï¸' },
            dash: { cd: 3, duration: 0.2, timer: 0, active: 0, lastUsed: 0, price: 1000, icon: 'âš¡' }
        };

        const ballSkins = [
            { id: 'classic', name: 'Classic', colors: ['#ffcc00', '#0044cc'], price: 0 },
            { id: 'ruby', name: 'Ruby Strike', colors: ['#aa0000', '#330000'], price: 100 },
            { id: 'emerald', name: 'Emerald Forest', colors: ['#00ff44', '#002200'], price: 250 },
            { id: 'galaxy', name: 'Galaxy Void', colors: ['#110022', '#440088'], price: 500 },
            { id: 'golden', name: 'Golden Legend', colors: ['#ffd700', '#8b4513'], price: 1000 }
        ];

        let unlockedSkins = JSON.parse(localStorage.getItem('starball_unlocked')) || ['classic'];
        let selectedSkin = localStorage.getItem('starball_skin') || 'classic';
        
        // Yetenek envanteri (SayÄ±sal tutulur)
        let abilityInventory = JSON.parse(localStorage.getItem('starball_inventory')) || {
            dash: 0, shield: 0, magnet: 0, slow: 0
        };

        const levels = [
            { grid: 9, stars: 5, enemies: 1, tracking: false },
            { grid: 9, stars: 8, enemies: 2, tracking: false },
            { grid: 10, stars: 12, enemies: 3, tracking: true },
            { grid: 10, stars: 15, enemies: 4, tracking: true },
            { grid: 11, stars: 20, enemies: 5, tracking: true }
        ];

        const baseMaze = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,1,0,1,0,1,1,1,0,1],
            [1,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0,1],
            [1,0,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1],
            [1,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,1],
            [1,1,1,1,1,0,1,1,1,0,1,0,1,0,0,0,1],
            [1,0,0,0,1,0,0,0,0,0,1,0,1,1,1,0,1],
            [1,0,1,0,1,1,1,1,1,0,1,0,0,0,1,0,1],
            [1,0,1,0,0,0,0,0,1,0,1,1,1,0,1,0,1],
            [1,0,1,1,1,0,1,0,1,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,1,0,0,0,1,1,1,1,1,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        const BALL_RADIUS = 1.55; 
        const PLAYER_SPEED = 0.5; 
        const DASH_MULTIPLIER = 3.5;
        const WALL_HEIGHT = 4.5;
        let offsetX, offsetZ;
        const keys = { w: false, a: false, s: false, d: false };
        let currentCameraPos = new THREE.Vector3();

        window.onload = () => {
            updateCoinDisplay();
            initThree();
            renderLevelButtons();
            renderShop();
            updateAbilityHUD();
        };

        function updateCoinDisplay() {
            document.getElementById('global-coins').innerText = globalCoins;
            const shopCoinDisplay = document.getElementById('shop-coins-display');
            if (shopCoinDisplay) shopCoinDisplay.innerText = globalCoins;
            localStorage.setItem('starball_coins', globalCoins);
            localStorage.setItem('starball_inventory', JSON.stringify(abilityInventory));
        }

        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050000); 
            clock = new THREE.Clock();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1500);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            window.addEventListener('keydown', e => { 
                const k = e.key.toLowerCase(); 
                if(keys.hasOwnProperty(k)) keys[k] = true;
                if(e.code === 'Space') handleCameraToggle();
                if(k === 'f') handleShoot();
                if(k === '1') useAbility('dash');
                if(k === '2') useAbility('shield');
                if(k === '3') useAbility('magnet');
                if(k === '4') useAbility('slow');
            });
            window.addEventListener('keyup', e => { 
                const k = e.key.toLowerCase(); if(keys.hasOwnProperty(k)) keys[k] = false;
            });
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            animate();
        }

        function useAbility(type) {
            if (isPaused || isGameOver) return;
            
            // Kontrol: Envanterde var mÄ±?
            if (abilityInventory[type] <= 0) return;

            const abi = abilities[type];
            const now = Date.now() / 1000;
            
            // Kontrol: Cooldown bitti mi?
            if (now - abi.lastUsed < abi.cd) return;

            // KULLANIM GERÃ‡EKLEÅžTÄ°
            abilityInventory[type]--; // BÄ°R ADET EKSÄ°LT
            abi.lastUsed = now;
            abi.active = abi.duration;
            
            updateCoinDisplay(); // LocalStorage gÃ¼ncelle
            updateAbilityHUD();
            
            document.getElementById(`abi-${type}`).classList.add('active');
            if (type === 'shield' && abilities.shield.mesh) player.add(abilities.shield.mesh);
        }

        function updateAbilityHUD() {
            for (const key in abilityInventory) {
                const count = abilityInventory[key];
                const box = document.getElementById(`abi-${key}`);
                const countDisplay = document.getElementById(`count-${key}`);
                
                if (countDisplay) countDisplay.innerText = count;
                
                if (count > 0) box.classList.add('available');
                else box.classList.remove('available');
            }
        }

        function updateAbilities(dt) {
            const now = Date.now() / 1000;
            for (const key in abilities) {
                const abi = abilities[key];
                const box = document.getElementById(`abi-${key}`);

                if (abi.active > 0) {
                    abi.active -= dt;
                    if (abi.active <= 0) {
                        box.classList.remove('active');
                        if (key === 'shield' && abi.mesh) player.remove(abi.mesh);
                    }
                }
                const timeSinceUsed = now - abi.lastUsed;
                const cdPercent = Math.max(0, 1 - (timeSinceUsed / abi.cd)) * 100;
                document.getElementById(`cd-${key}`).style.height = cdPercent + "%";
            }
            if (abilities.magnet.active > 0) {
                stars.forEach(star => {
                    if (player.position.distanceTo(star.position) < abilities.magnet.range) {
                        star.position.add(player.position.clone().sub(star.position).normalize().multiplyScalar(0.8));
                    }
                });
            }
        }

        function showLevelSelect() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('level-select').style.display = 'flex';
        }

        function openShop() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('shop-screen').style.display = 'flex';
            renderShop();
        }

        function switchShopTab(tab) {
            activeShopTab = tab;
            document.getElementById('tab-balls').classList.toggle('active', tab === 'balls');
            document.getElementById('tab-abilities').classList.toggle('active', tab === 'abilities');
            renderShop();
        }

        function backToMenu() {
            isPaused = true;
            document.getElementById('level-select').style.display = 'none';
            document.getElementById('shop-screen').style.display = 'none';
            document.getElementById('message').style.display = 'none';
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('ability-hud').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        function startGame(levelIndex) {
            currentLevel = levelIndex + 1;
            isPaused = false;
            document.getElementById('level-select').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('ability-hud').style.display = 'flex';
            updateAbilityHUD();
            setupGame();
        }

        function renderLevelButtons() {
            const container = document.getElementById('level-buttons');
            container.innerHTML = '';
            levels.forEach((lvl, i) => {
                const card = document.createElement('div');
                card.innerHTML = `<button class="menu-btn" style="min-width:120px; font-size:16px; padding:10px;">LVL ${i+1}</button>`;
                card.querySelector('button').onclick = () => startGame(i);
                container.appendChild(card);
            });
        }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '';
            if (activeShopTab === 'balls') {
                ballSkins.forEach(skin => {
                    const isUnlocked = unlockedSkins.includes(skin.id);
                    const isSelected = selectedSkin === skin.id;
                    const item = document.createElement('div');
                    item.className = `shop-item ${isSelected ? 'selected' : ''}`;
                    item.innerHTML = `
                        <div class="ball-preview" style="background: linear-gradient(135deg, ${skin.colors[0]}, ${skin.colors[1]})"></div>
                        <div style="font-weight:bold; font-size:14px;">${skin.name}</div>
                        <div style="color:#00ffcc; font-weight:bold; margin:10px 0;">${isUnlocked ? 'SAHÄ°P' : skin.price + ' ALTIN'}</div>
                        <button class="menu-btn secondary" style="min-width:100%; font-size:12px; padding:8px 0;">${isSelected ? 'SEÃ‡Ä°LÄ°' : (isUnlocked ? 'SEÃ‡' : 'SATIN AL')}</button>
                    `;
                    item.querySelector('button').onclick = () => {
                        if (isUnlocked) { selectedSkin = skin.id; localStorage.setItem('starball_skin', selectedSkin); }
                        else if (globalCoins >= skin.price) {
                            globalCoins -= skin.price; unlockedSkins.push(skin.id);
                            localStorage.setItem('starball_unlocked', JSON.stringify(unlockedSkins));
                            selectedSkin = skin.id; localStorage.setItem('starball_skin', selectedSkin);
                            updateCoinDisplay();
                        }
                        renderShop();
                    };
                    grid.appendChild(item);
                });
            } else {
                const abilityKeys = ['magnet', 'slow', 'shield', 'dash'];
                abilityKeys.forEach(key => {
                    const abi = abilities[key];
                    const currentCount = abilityInventory[key];
                    const item = document.createElement('div');
                    item.className = `shop-item`;
                    item.innerHTML = `
                        <div class="ability-icon">${abi.icon}</div>
                        <div style="font-weight:bold; font-size:14px; text-transform:uppercase;">${key}</div>
                        <div style="color:orange; font-size:12px; margin-bottom:5px;">Sende: ${currentCount} Adet</div>
                        <div style="color:#00ffcc; font-weight:bold; margin:5px 0;">${abi.price} ALTIN</div>
                        <button class="menu-btn secondary" style="min-width:100%; font-size:12px; padding:8px 0;">+1 SATIN AL</button>
                    `;
                    item.querySelector('button').onclick = () => {
                        if (globalCoins >= abi.price) {
                            globalCoins -= abi.price;
                            abilityInventory[key]++;
                            updateCoinDisplay();
                            updateAbilityHUD();
                            renderShop();
                        }
                    };
                    grid.appendChild(item);
                });
            }
        }

        function setupGame() {
            const lvl = levels[currentLevel-1];
            score = 0; isGameOver = false; isFPS = false;
            document.getElementById('score').innerText = 0;
            document.getElementById('target-score').innerText = lvl.stars;
            document.getElementById('message').style.display = "none";
            while(scene.children.length > 0){ scene.remove(scene.children[0]); }
            scene.add(new THREE.AmbientLight(0xffcccc, 0.4));
            const light = new THREE.PointLight(0xffffff, 1.5, 1500); light.position.set(0, 200, 0); scene.add(light);
            stars = []; enemies = []; mazeWalls = []; iceProjectiles = [];
            offsetX = (baseMaze[0].length * lvl.grid) / 2; offsetZ = (baseMaze.length * lvl.grid) / 2;
            createWorld(lvl); createPlayer(); spawnItems(lvl);
            currentCameraPos.copy(player.position).add(new THREE.Vector3(0, 45, 25));
        }

        function createWorld(lvl) {
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(2000, 2000), new THREE.MeshPhongMaterial({ color: 0x110505 }));
            floor.rotation.x = -Math.PI / 2; scene.add(floor);
            const wallGeo = new THREE.BoxGeometry(lvl.grid, WALL_HEIGHT, lvl.grid);
            const wallMat = new THREE.MeshPhongMaterial({ color: 0x2222ff });
            for(let z = 0; z < baseMaze.length; z++) {
                for(let x = 0; x < baseMaze[0].length; x++) {
                    if(baseMaze[z][x] === 1) {
                        const wall = new THREE.Mesh(wallGeo, wallMat);
                        wall.position.set(x * lvl.grid - offsetX + lvl.grid/2, WALL_HEIGHT/2, z * lvl.grid - offsetZ + lvl.grid/2);
                        scene.add(wall); mazeWalls.push(wall);
                    }
                }
            }
        }

        function getSafePos() {
            const lvl = levels[currentLevel-1];
            let rx, rz;
            do { rx = Math.floor(Math.random() * baseMaze[0].length); rz = Math.floor(Math.random() * baseMaze.length); } while (baseMaze[rz][rx] !== 0);
            return new THREE.Vector3(rx * lvl.grid - offsetX + lvl.grid/2, BALL_RADIUS, rz * lvl.grid - offsetZ + lvl.grid/2);
        }

        function createPlayer() {
            player = new THREE.Group(); player.position.copy(getSafePos()); scene.add(player);
            playerBall = new THREE.Group(); player.add(playerBall);
            const skin = ballSkins.find(s => s.id === selectedSkin);
            const top = new THREE.Mesh(new THREE.SphereGeometry(BALL_RADIUS, 32, 16, 0, Math.PI*2, 0, Math.PI/2), new THREE.MeshPhongMaterial({ color: skin.colors[0] }));
            const bot = new THREE.Mesh(new THREE.SphereGeometry(BALL_RADIUS, 32, 16, 0, Math.PI*2, Math.PI/2, Math.PI/2), new THREE.MeshPhongMaterial({ color: skin.colors[1] }));
            playerBall.add(top, bot);
            abilities.shield.mesh = new THREE.Mesh(new THREE.SphereGeometry(BALL_RADIUS*1.5, 32, 32), new THREE.MeshPhongMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3, wireframe: true }));
        }

        function spawnItems(lvl) {
            const starGeo = new THREE.CylinderGeometry(0.8, 0.8, 0.3, 32);
            for(let i=0; i < lvl.stars; i++) {
                const star = new THREE.Mesh(starGeo, new THREE.MeshPhongMaterial({ color: 0xffff00 }));
                star.position.copy(getSafePos()).setY(2.2); star.rotation.x = Math.PI / 2; scene.add(star); stars.push(star);
            }
            for(let i=0; i < lvl.enemies; i++) {
                const enemy = new THREE.Group(); enemy.position.copy(getSafePos());
                enemy.add(new THREE.Mesh(new THREE.SphereGeometry(BALL_RADIUS, 32, 32), new THREE.MeshPhongMaterial({ color: 0x9900ee })));
                const ice = new THREE.Mesh(new THREE.IcosahedronGeometry(BALL_RADIUS*1.3, 1), new THREE.MeshPhongMaterial({ color: 0x00ffff, transparent: true, opacity: 0 }));
                enemy.add(ice);
                enemy.userData = { dir: new THREE.Vector3(1,0,0).applyAxisAngle(new THREE.Vector3(0,1,0), Math.random()*Math.PI*2), frozen: 0, ice: ice, tracking: lvl.tracking };
                scene.add(enemy); enemies.push(enemy);
            }
        }

        function checkCollision(pos) {
            const lvl = levels[currentLevel-1];
            const m = BALL_RADIUS + 0.3;
            for (let z = 0; z < baseMaze.length; z++) {
                for (let x = 0; x < baseMaze[0].length; x++) {
                    if (baseMaze[z][x] === 1) {
                        const wx = x * lvl.grid - offsetX + lvl.grid/2, wz = z * lvl.grid - offsetZ + lvl.grid/2;
                        if (Math.abs(pos.x - wx) < (lvl.grid/2 + m) && Math.abs(pos.z - wz) < (lvl.grid/2 + m)) return true;
                    }
                }
            }
            return false;
        }

        function handleCameraToggle() { if (!isGameOver && !isPaused) { isFPS = !isFPS; playerBall.visible = !isFPS; document.getElementById('crosshair').style.display = isFPS ? 'block' : 'none'; } }

        function handleShoot() {
            if (isGameOver || isPaused) return;
            const ice = new THREE.Mesh(new THREE.SphereGeometry(0.7, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
            ice.position.copy(player.position);
            ice.userData = { vel: new THREE.Vector3(0,0,-1).applyQuaternion(camera.quaternion).multiplyScalar(2.2) };
            scene.add(ice); iceProjectiles.push(ice);
        }

        function updatePlayer() {
            if (isGameOver || isPaused || !player) return;
            const prev = player.position.clone();
            let move = new THREE.Vector3(0,0,0);
            const speed = (abilities.dash.active > 0) ? PLAYER_SPEED * DASH_MULTIPLIER : PLAYER_SPEED;
            if (isFPS) {
                if (keys.w) move.z -= 1; if (keys.s) move.z += 1;
                if (keys.a) player.rotation.y += 0.05; if (keys.d) player.rotation.y -= 0.05;
                move.applyMatrix4(new THREE.Matrix4().makeRotationY(player.rotation.y));
            } else {
                if (keys.w) move.z -= 1; if (keys.s) move.z += 1;
                if (keys.a) move.x -= 1; if (keys.d) move.x += 1;
                if (move.length() > 0) player.rotation.y += (Math.atan2(move.x, move.z) - player.rotation.y) * 0.15;
            }
            if (move.length() > 0) {
                move.normalize().multiplyScalar(speed);
                player.position.x += move.x; if (checkCollision(player.position)) player.position.x = prev.x;
                player.position.z += move.z; if (checkCollision(player.position)) player.position.z = prev.z;
                if (!player.position.equals(prev)) playerBall.rotation.x -= player.position.distanceTo(prev) / BALL_RADIUS;
            }
            if (isFPS) { camera.position.set(player.position.x, player.position.y + 1, player.position.z); camera.quaternion.copy(player.quaternion); }
            else { currentCameraPos.lerp(new THREE.Vector3(player.position.x, player.position.y + 45, player.position.z + 25), 0.1); camera.position.copy(currentCameraPos); camera.lookAt(player.position); }

            for (let i = stars.length - 1; i >= 0; i--) {
                if (player.position.distanceTo(stars[i].position) < 3.0) {
                    score++; globalCoins += 10; updateCoinDisplay();
                    document.getElementById('score').innerText = score;
                    scene.remove(stars[i]); stars.splice(i, 1);
                    if(score >= levels[currentLevel-1].stars) winGame();
                }
            }
        }

        function updateEnemies(dt) {
            let speed = (0.28 + currentLevel*0.03) * (abilities.slow.active > 0 ? 0.3 : 1);
            enemies.forEach(e => {
                if (e.userData.frozen > 0) { e.userData.frozen -= dt; e.userData.ice.material.opacity = 0.7; return; }
                e.userData.ice.material.opacity = 0;
                const prev = e.position.clone();
                if (e.userData.tracking && player.position.distanceTo(e.position) < 40) e.userData.dir.lerp(player.position.clone().sub(e.position).normalize(), 0.05);
                e.position.add(e.userData.dir.clone().multiplyScalar(speed));
                if (checkCollision(e.position)) { e.position.copy(prev); e.userData.dir.applyAxisAngle(new THREE.Vector3(0,1,0), Math.random()*Math.PI + Math.PI/2); }
                if (!isGameOver && e.position.distanceTo(player.position) < 3.0) {
                    if (abilities.shield.active > 0) { abilities.shield.active = 0; player.remove(abilities.shield.mesh); e.userData.frozen = 2.0; }
                    else gameOver();
                }
            });
            for (let i = iceProjectiles.length - 1; i >= 0; i--) {
                const p = iceProjectiles[i]; p.position.add(p.userData.vel);
                if (checkCollision(p.position)) { scene.remove(p); iceProjectiles.splice(i, 1); continue; }
                enemies.forEach(e => { if (p.position.distanceTo(e.position) < 3.0) { e.userData.frozen = 3.0; scene.remove(p); iceProjectiles.splice(i, 1); } });
            }
        }

        function winGame() {
            isGameOver = true;
            if (!completedLevels.includes(currentLevel)) { completedLevels.push(currentLevel); localStorage.setItem('starball_completed', JSON.stringify(completedLevels)); }
            document.getElementById('msg-content').innerHTML = `<span style="color:gold">SEVÄ°YE ${currentLevel} TAMAMLANDI!</span>`;
            document.getElementById('next-lvl-btn').style.display = currentLevel < levels.length ? "block" : "none";
            document.getElementById('next-lvl-btn').onclick = () => startGame(currentLevel);
            document.getElementById('message').style.display = "block";
        }

        function gameOver() { isGameOver = true; document.getElementById('msg-content').innerHTML = `<span style="color:#ff3333">OYUN BÄ°TTÄ°</span>`; document.getElementById('message').style.display = "block"; }

        function animate() {
            requestAnimationFrame(animate);
            if (!isPaused) {
                const dt = clock.getDelta(); updatePlayer(); updateEnemies(dt); updateAbilities(dt);
                stars.forEach(s => s.rotation.y += 0.05);
                if (abilities.shield.active > 0 && abilities.shield.mesh) { abilities.shield.mesh.rotation.y += 0.02; abilities.shield.mesh.rotation.z += 0.01; }
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>